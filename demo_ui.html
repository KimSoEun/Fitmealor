<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitmealor - AI ÏãùÎã® Ï∂îÏ≤ú</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }
        .header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:active {
            transform: translateY(0);
        }
        .meal-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }
        .meal-card h3 {
            color: #333;
            margin-bottom: 10px;
        }
        .meal-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .safe-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .safe {
            background: #d4edda;
            color: #155724;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
        }
        #results {
            display: none;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 18px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        .allergen-checkboxes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .checkbox-item:hover {
            background: #e9ecef;
        }
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }
        .checkbox-item label {
            margin: 0;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            flex: 1;
        }
        .filter-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
        .filter-info strong {
            color: #856404;
        }
        .nav-bar {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .nav-bar a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 10px;
            transition: background 0.3s;
            font-weight: 600;
        }
        .nav-bar a:hover {
            background: rgba(255,255,255,0.2);
        }
        .nav-links {
            display: flex;
            gap: 10px;
        }
        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .chat-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .chat-message.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        .chat-message.assistant {
            background: white;
            color: #333;
            align-self: flex-start;
            border: 1px solid #e0e0e0;
        }
        .chat-input-group {
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }
        .chat-send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .chat-send-btn:hover {
            transform: translateY(-2px);
        }
        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .recommendation-reason {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .recommendation-reason h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .recommendation-reason p {
            color: #333;
            line-height: 1.6;
            margin: 0;
        }
        .user-info {
            color: white;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-name {
            font-weight: 600;
        }
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .container {
                padding: 0;
            }
            .header h1 {
                font-size: 2em;
            }
            .header p {
                font-size: 0.9em;
            }
            .card {
                padding: 20px;
                border-radius: 15px;
            }
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            .meal-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .allergen-checkboxes {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            .checkbox-item {
                padding: 8px;
            }
            .checkbox-item label {
                font-size: 12px;
            }
            .nav-bar {
                flex-direction: column;
                gap: 10px;
                padding: 10px;
            }
            .nav-links {
                flex-direction: column;
                width: 100%;
            }
            .nav-links a {
                text-align: center;
                width: 100%;
            }
            .user-info {
                flex-direction: column;
                gap: 5px;
                width: 100%;
            }
            .user-info a {
                width: 100%;
                text-align: center;
            }
            .meal-card {
                padding: 15px;
            }
            .meal-card h3 {
                font-size: 1.1em;
            }
            .stat-value {
                font-size: 18px;
            }
            .stat-label {
                font-size: 11px;
            }
            input, select {
                font-size: 16px;
                padding: 14px;
            }
            .btn {
                padding: 16px 30px;
                font-size: 16px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            label {
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }
            .card {
                padding: 15px;
            }
            .allergen-checkboxes {
                grid-template-columns: 1fr;
            }
            .meal-stats {
                grid-template-columns: 1fr;
            }
            .checkbox-item label {
                font-size: 13px;
            }
        }

        /* Typing indicator animation */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 10px 15px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #667eea;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: translateY(0);
            }
            30% {
                opacity: 1;
                transform: translateY(-10px);
            }
        }

        /* Language toggle switch */
        .language-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .language-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
        }

        .language-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .language-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: 0.4s;
            border-radius: 28px;
        }

        .language-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .language-switch input:checked + .language-slider:before {
            transform: translateX(32px);
        }

        .language-label {
            font-size: 14px;
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar" id="navBar" style="display: none;">
            <div class="nav-links">
                <a href="demo_ui.html" data-lang-en="üè† Home" data-lang-ko="üè† Ìôà"></a>
                <a href="profile.html" data-lang-en="üë§ Profile" data-lang-ko="üë§ ÌîÑÎ°úÌïÑ"></a>
            </div>
            <div class="user-info">
                <span class="user-name" id="navUserName">User</span>
                <a href="#" id="navLogoutBtn" data-lang-en="üö™ Logout" data-lang-ko="üö™ Î°úÍ∑∏ÏïÑÏõÉ"></a>
                <!-- Language Toggle -->
                <div class="language-toggle" style="position: relative; margin-left: 20px;">
                    <span class="language-label">KO</span>
                    <label class="language-switch">
                        <input type="checkbox" id="languageToggle">
                        <span class="language-slider"></span>
                    </label>
                    <span class="language-label">EN</span>
                </div>
            </div>
        </div>

        <div class="header">
            <h1>ü•ó Fitmealor</h1>
            <p data-lang-en="AI-Powered Meal Recommendations for Foreigners in Korea" data-lang-ko="Ïô∏Íµ≠Ïù∏ÏùÑ ÏúÑÌïú AI Í∏∞Î∞ò ÏãùÎã® Ï∂îÏ≤ú ÏÑúÎπÑÏä§"></p>
        </div>

        <div class="card" id="welcomeCard" style="display: none;">
            <h2 style="color: #667eea; margin-bottom: 15px;" data-lang-en="üëã Welcome!" data-lang-ko="üëã ÌôòÏòÅÌï©ÎãàÎã§!"></h2>
            <p style="font-size: 1.1em; color: #333; margin-bottom: 20px;" id="welcomeMessage">
                <strong id="welcomeUserName">User</strong><span data-lang-en="'s personalized meal recommendations based on your health profile." data-lang-ko="ÎãòÏùò Í±¥Í∞ï ÌîÑÎ°úÌïÑÏùÑ Í∏∞Î∞òÏúºÎ°ú ÎßûÏ∂§ ÏãùÎã®ÏùÑ Ï∂îÏ≤úÌï¥ÎìúÎ¶ΩÎãàÎã§."></span>
            </p>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                <div class="grid">
                    <div>
                        <p style="color: #666; margin-bottom: 5px;" data-lang-en="üéØ Goal" data-lang-ko="üéØ Í±¥Í∞ï Î™©Ìëú"></p>
                        <p style="font-weight: 600; color: #667eea;" id="welcomeGoal">-</p>
                    </div>
                    <div>
                        <p style="color: #666; margin-bottom: 5px;" data-lang-en="üìä Daily Calories" data-lang-ko="üìä ÏùºÏùº Í∂åÏû• ÏπºÎ°úÎ¶¨"></p>
                        <p style="font-weight: 600; color: #667eea;" id="welcomeTDEE">-</p>
                    </div>
                    <div>
                        <p style="color: #666; margin-bottom: 5px;" data-lang-en="‚öñÔ∏è Current Weight" data-lang-ko="‚öñÔ∏è ÌòÑÏû¨ Ï≤¥Ï§ë"></p>
                        <p style="font-weight: 600; color: #667eea;" id="welcomeWeight">-</p>
                    </div>
                    <div>
                        <p style="color: #666; margin-bottom: 5px;" data-lang-en="üéØ Target Weight" data-lang-ko="üéØ Î™©Ìëú Ï≤¥Ï§ë"></p>
                        <p style="font-weight: 600; color: #667eea;" id="welcomeTargetWeight">-</p>
                    </div>
                </div>
            </div>
            <p style="color: #666; text-align: center; margin-top: 15px;" data-lang-en="Tell us about your body condition today ‚¨áÔ∏è" data-lang-ko="Ïò§ÎäòÏùò Î™∏ ÏÉÅÌÉúÎ•º ÏïÑÎûòÏóê ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî ‚¨áÔ∏è"></p>
        </div>

        <!-- Chat Interface -->
        <div class="card" id="chatCard" style="display: none;">
            <h2 style="margin-bottom: 15px;" data-lang-en="üí¨ Chat with AI Nutritionist" data-lang-ko="üí¨ AI ÏòÅÏñëÏÇ¨ÏôÄ ÎåÄÌôîÌïòÍ∏∞"></h2>
            <p style="color: #666; margin-bottom: 15px; font-size: 0.95em;" data-lang-en="How are you feeling today? Tell us about fatigue, digestion, muscle pain, etc." data-lang-ko="Ïò§Îäò Î™∏ ÏÉÅÌÉúÍ∞Ä Ïñ¥Îñ†Ïã†Í∞ÄÏöî? ÌîºÍ≥§Ìï®, ÏÜåÌôîÎ∂àÎüâ, Í∑ºÏú°ÌÜµ Îì±ÏùÑ ÏûêÏú†Î°≠Í≤å ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî."></p>

            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-message assistant" id="initialChatMessage" data-lang-en="üëã Hello! I'm Fitmealor's AI nutritionist. How are you feeling today? Feel free to tell me what you'd like to eat!" data-lang-ko="üëã ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî FitmealorÏùò AI ÏòÅÏñëÏÇ¨ÏûÖÎãàÎã§. Ïò§Îäò Î™∏ ÏÉÅÌÉúÍ∞Ä Ïñ¥Îñ†Ïã†Í∞ÄÏöî? Î®πÍ≥† Ïã∂ÏùÄ ÏùåÏãùÎèÑ ÏûêÏú†Î°≠Í≤å ÎßêÏîÄÌï¥Ï£ºÏÑ∏Ïöî!"></div>
                </div>

                <div class="chat-input-group">
                    <input type="text"
                           class="chat-input"
                           id="chatInput"
                           data-placeholder-en="e.g., I'm tired today. I want something spicy"
                           data-placeholder-ko="Ïòà: Ïò§Îäò ÌîºÍ≥§Ìï¥Ïöî. Îß§Ïö¥ ÏùåÏãù Î®πÍ≥† Ïã∂Ïñ¥Ïöî"
                           maxlength="300">
                    <button class="chat-send-btn" id="chatSendBtn" data-lang-en="üí¨ Send" data-lang-ko="üí¨ Ï†ÑÏÜ°"></button>
                </div>
            </div>
        </div>

        <div class="card" id="allergenFilterCard" style="display: none;">
            <h2 style="margin-bottom: 20px;" data-lang-en="üö´ Allergen Filters" data-lang-ko="üö´ ÏïåÎü¨ÏßÄ ÌïÑÌÑ∞"></h2>
            <p style="color: #666; margin-bottom: 15px;" data-lang-en="Select allergens to exclude meals containing those ingredients." data-lang-ko="ÏïåÎü¨ÏßÄÍ∞Ä ÏûàÎäî Ìï≠Î™©ÏùÑ ÏÑ†ÌÉùÌïòÎ©¥ Ìï¥Îãπ ÏÑ±Î∂ÑÏù¥ Ìè¨Ìï®Îêú ÏãùÎã®ÏùÄ Ï†úÏô∏Îê©ÎãàÎã§."></p>
            <div class="allergen-checkboxes">
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-eggs" value="eggs" class="allergen-filter-checkbox">
                    <label for="filter-eggs" data-lang-en="Eggs" data-lang-ko="ÎÇúÎ•ò"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-milk" value="milk" class="allergen-filter-checkbox">
                    <label for="filter-milk" data-lang-en="Milk" data-lang-ko="Ïö∞Ïú†"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-buckwheat" value="buckwheat" class="allergen-filter-checkbox">
                    <label for="filter-buckwheat" data-lang-en="Buckwheat" data-lang-ko="Î©îÎ∞Ä"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-peanuts" value="peanuts" class="allergen-filter-checkbox">
                    <label for="filter-peanuts" data-lang-en="Peanuts" data-lang-ko="ÎïÖÏΩ©"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-soybeans" value="soybeans" class="allergen-filter-checkbox">
                    <label for="filter-soybeans" data-lang-en="Soybeans" data-lang-ko="ÎåÄÎëê"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-wheat" value="wheat" class="allergen-filter-checkbox">
                    <label for="filter-wheat" data-lang-en="Wheat" data-lang-ko="Î∞Ä"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-mackerel" value="mackerel" class="allergen-filter-checkbox">
                    <label for="filter-mackerel" data-lang-en="Mackerel" data-lang-ko="Í≥†Îì±Ïñ¥"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-crab" value="crab" class="allergen-filter-checkbox">
                    <label for="filter-crab" data-lang-en="Crab" data-lang-ko="Í≤å"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-shrimp" value="shrimp" class="allergen-filter-checkbox">
                    <label for="filter-shrimp" data-lang-en="Shrimp" data-lang-ko="ÏÉàÏö∞"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-pork" value="pork" class="allergen-filter-checkbox">
                    <label for="filter-pork" data-lang-en="Pork" data-lang-ko="ÎèºÏßÄÍ≥†Í∏∞"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-peach" value="peach" class="allergen-filter-checkbox">
                    <label for="filter-peach" data-lang-en="Peach" data-lang-ko="Î≥µÏà≠ÏïÑ"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-tomato" value="tomato" class="allergen-filter-checkbox">
                    <label for="filter-tomato" data-lang-en="Tomato" data-lang-ko="ÌÜ†ÎßàÌÜ†"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-sulfites" value="sulfites" class="allergen-filter-checkbox">
                    <label for="filter-sulfites" data-lang-en="Sulfites" data-lang-ko="ÏïÑÌô©ÏÇ∞Î•ò"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-walnuts" value="walnuts" class="allergen-filter-checkbox">
                    <label for="filter-walnuts" data-lang-en="Walnuts" data-lang-ko="Ìò∏Îëê"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-chicken" value="chicken" class="allergen-filter-checkbox">
                    <label for="filter-chicken" data-lang-en="Chicken" data-lang-ko="Îã≠Í≥†Í∏∞"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-beef" value="beef" class="allergen-filter-checkbox">
                    <label for="filter-beef" data-lang-en="Beef" data-lang-ko="Ïá†Í≥†Í∏∞"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-squid" value="squid" class="allergen-filter-checkbox">
                    <label for="filter-squid" data-lang-en="Squid" data-lang-ko="Ïò§ÏßïÏñ¥"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-shellfish" value="shellfish" class="allergen-filter-checkbox">
                    <label for="filter-shellfish" data-lang-en="Shellfish" data-lang-ko="Ï°∞Í∞úÎ•ò"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-pine-nuts" value="pine_nuts" class="allergen-filter-checkbox">
                    <label for="filter-pine-nuts" data-lang-en="Pine Nuts" data-lang-ko="Ïû£"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-mussels" value="mussels" class="allergen-filter-checkbox">
                    <label for="filter-mussels" data-lang-en="Mussels" data-lang-ko="ÌôçÌï©"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-abalone" value="abalone" class="allergen-filter-checkbox">
                    <label for="filter-abalone" data-lang-en="Abalone" data-lang-ko="Ï†ÑÎ≥µ"></label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filter-oysters" value="oysters" class="allergen-filter-checkbox">
                    <label for="filter-oysters" data-lang-en="Oysters" data-lang-ko="Íµ¥"></label>
                </div>
            </div>
        </div>

        <div class="card" id="healthFormCard">
            <h2 style="margin-bottom: 20px;">Enter Your Health Information / Í±¥Í∞ï Ï†ïÎ≥¥ ÏûÖÎ†•</h2>
            <p style="color: #666; margin-bottom: 20px;">
                Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ ÏÇ¨Ïö©ÏûêÎ•º ÏúÑÌïú ÏûÑÏãú ÏûÖÎ†• ÌèºÏûÖÎãàÎã§. ÌöåÏõêÍ∞ÄÏûÖÌïòÏãúÎ©¥ Ï†ïÎ≥¥Í∞Ä ÏûêÎèôÏúºÎ°ú Ï†ÄÏû•Îê©ÎãàÎã§.
            </p>
            <form id="healthForm">
                <div class="grid">
                    <div class="form-group">
                        <label>Age / ÎÇòÏù¥</label>
                        <input type="number" id="age" value="28" required>
                    </div>
                    <div class="form-group">
                        <label>Gender / ÏÑ±Î≥Ñ</label>
                        <select id="gender">
                            <option value="unspecified">Prefer not to say / ÏÑ†ÌÉù Ïïà Ìï®</option>
                            <option value="male">Male / ÎÇ®ÏÑ±</option>
                            <option value="female">Female / Ïó¨ÏÑ±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Height / ÌÇ§ (cm)</label>
                        <input type="number" id="height" value="175" required>
                    </div>
                    <div class="form-group">
                        <label>Weight / Ï≤¥Ï§ë (kg)</label>
                        <input type="number" id="weight" value="70" required>
                    </div>
                    <div class="form-group">
                        <label>Target Weight / Î™©Ìëú Ï≤¥Ï§ë (kg)</label>
                        <input type="number" id="targetWeight" value="65" required>
                    </div>
                    <div class="form-group">
                        <label>Activity Level / ÌôúÎèôÎüâ</label>
                        <select id="activity">
                            <option value="sedentary">Sedentary / ÎπÑÌôúÎèôÏ†Å</option>
                            <option value="light">Light / Í∞ÄÎ≤ºÏö¥ ÌôúÎèô</option>
                            <option value="moderate" selected>Moderate / Î≥¥ÌÜµ</option>
                            <option value="active">Active / ÌôúÎèôÏ†Å</option>
                            <option value="very_active">Very Active / Îß§Ïö∞ ÌôúÎèôÏ†Å</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Health Goal / Í±¥Í∞ï Î™©Ìëú</label>
                    <select id="goal">
                        <option value="lose_weight">Lose Weight / Ï≤¥Ï§ë Í∞êÎüâ</option>
                        <option value="maintain">Maintain / Ïú†ÏßÄ</option>
                        <option value="gain_muscle">Gain Muscle / Í∑ºÏú° Ï¶ùÍ∞Ä</option>
                        <option value="bulk_up">Bulk Up / Î≤åÌÅ¨ÏóÖ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Allergy Filters / ÏïåÎ†àÎ•¥Í∏∞ ÌïÑÌÑ∞</label>
                    <div class="allergen-checkboxes">
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-eggs" value="eggs" class="allergen-checkbox">
                            <label for="allergy-eggs">Eggs / ÎÇúÎ•ò</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-milk" value="milk" class="allergen-checkbox">
                            <label for="allergy-milk">Milk / Ïö∞Ïú†</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-buckwheat" value="buckwheat" class="allergen-checkbox">
                            <label for="allergy-buckwheat">Buckwheat / Î©îÎ∞Ä</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-peanuts" value="peanuts" class="allergen-checkbox">
                            <label for="allergy-peanuts">Peanuts / ÎïÖÏΩ©</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-soybeans" value="soybeans" class="allergen-checkbox">
                            <label for="allergy-soybeans">Soybeans / ÎåÄÎëê</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-wheat" value="wheat" class="allergen-checkbox">
                            <label for="allergy-wheat">Wheat / Î∞Ä</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-mackerel" value="mackerel" class="allergen-checkbox">
                            <label for="allergy-mackerel">Mackerel / Í≥†Îì±Ïñ¥</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-crab" value="crab" class="allergen-checkbox">
                            <label for="allergy-crab">Crab / Í≤å</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-shrimp" value="shrimp" class="allergen-checkbox">
                            <label for="allergy-shrimp">Shrimp / ÏÉàÏö∞</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-pork" value="pork" class="allergen-checkbox">
                            <label for="allergy-pork">Pork / ÎèºÏßÄÍ≥†Í∏∞</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-peach" value="peach" class="allergen-checkbox">
                            <label for="allergy-peach">Peach / Î≥µÏà≠ÏïÑ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-tomato" value="tomato" class="allergen-checkbox">
                            <label for="allergy-tomato">Tomato / ÌÜ†ÎßàÌÜ†</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-sulfites" value="sulfites" class="allergen-checkbox">
                            <label for="allergy-sulfites">Sulfites / ÏïÑÌô©ÏÇ∞Î•ò</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-walnuts" value="walnuts" class="allergen-checkbox">
                            <label for="allergy-walnuts">Walnuts / Ìò∏Îëê</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-chicken" value="chicken" class="allergen-checkbox">
                            <label for="allergy-chicken">Chicken / Îã≠Í≥†Í∏∞</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-beef" value="beef" class="allergen-checkbox">
                            <label for="allergy-beef">Beef / Ïá†Í≥†Í∏∞</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-squid" value="squid" class="allergen-checkbox">
                            <label for="allergy-squid">Squid / Ïò§ÏßïÏñ¥</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-shellfish" value="shellfish" class="allergen-checkbox">
                            <label for="allergy-shellfish">Shellfish / Ï°∞Í∞úÎ•ò</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-pine-nuts" value="pine_nuts" class="allergen-checkbox">
                            <label for="allergy-pine-nuts">Pine Nuts / Ïû£</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-mussels" value="mussels" class="allergen-checkbox">
                            <label for="allergy-mussels">Mussels / ÌôçÌï©</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-abalone" value="abalone" class="allergen-checkbox">
                            <label for="allergy-abalone">Abalone / Ï†ÑÎ≥µ</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allergy-oysters" value="oysters" class="allergen-checkbox">
                            <label for="allergy-oysters">Oysters / Íµ¥</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn">ü§ñ Get AI Recommendations / AI ÏãùÎã® Ï∂îÏ≤ú Î∞õÍ∏∞</button>
            </form>
        </div>

        <div id="results" class="card">
            <h2 style="margin-bottom: 20px;" data-lang-en="Recommended Meals" data-lang-ko="Ï∂îÏ≤ú ÏãùÎã®"></h2>

            <!-- Recommendation Reason -->
            <div id="recommendationReason" class="recommendation-reason" style="display: none;">
                <h3 data-lang-en="üí° Why these meals?" data-lang-ko="üí° Ïôú Ïù¥ ÏãùÎã®ÏùºÍπåÏöî?"></h3>
                <p id="reasonText"></p>
            </div>

            <div id="tdeeInfo" style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #1976d2;" data-lang-en="üìä Your Daily Calorie Target" data-lang-ko="üìä ÏùºÏùº Í∂åÏû• ÏπºÎ°úÎ¶¨"></h3>
                <p id="tdeeValue" style="font-size: 24px; font-weight: 700; color: #1976d2; margin-top: 10px;"></p>
            </div>
            <div id="filterInfo" class="filter-info" style="display: none;">
                <strong data-lang-en="üîç Active Filters:" data-lang-ko="üîç ÌôúÏÑ± ÌïÑÌÑ∞:"></strong>
                <p id="filterList" style="margin-top: 5px;"></p>
                <p id="filterStats" style="margin-top: 10px; font-size: 14px;"></p>
            </div>
            <div id="mealsContainer"></div>
        </div>
    </div>

    <script>
        // Language management
        let currentLanguage = localStorage.getItem('fitmealor_language') || 'ko';
        let currentRecommendations = null; // Store recommendations for language switching

        // Language message templates
        const messages = {
            loading: {
                en: '‚è≥ AI is analyzing your personalized meal plan...',
                ko: '‚è≥ AIÍ∞Ä ÎßûÏ∂§ ÏãùÎã®ÏùÑ Î∂ÑÏÑùÌïòÎäî Ï§ëÏûÖÎãàÎã§...'
            },
            noMeals: {
                en: 'No safe meals found with current filters. Try removing some allergen filters.',
                ko: 'ÌòÑÏû¨ ÌïÑÌÑ∞Î°úÎäî ÏïàÏ†ÑÌïú ÏãùÎã®ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÏïåÎü¨ÏßÄ ÌïÑÌÑ∞Î•º ÏùºÎ∂Ä Ï†úÍ±∞Ìï¥Î≥¥ÏÑ∏Ïöî.'
            },
            error: {
                en: '‚ùå Error: ',
                ko: '‚ùå Ïò§Î•ò: '
            },
            serverError: {
                en: 'Please make sure the server is running at http://localhost:8000',
                ko: 'ÏÑúÎ≤ÑÍ∞Ä http://localhost:8000 ÏóêÏÑú Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî'
            },
            filterStats: {
                en: (total, filtered, safe) => `üìä <strong>${total}</strong> total meals | <strong>${filtered}</strong> filtered out | <strong>${safe}</strong> safe recommendations`,
                ko: (total, filtered, safe) => `üìä Ï†ÑÏ≤¥ <strong>${total}</strong>Í∞ú | Ï†úÏô∏ <strong>${filtered}</strong>Í∞ú | ÏïàÏ†Ñ Ï∂îÏ≤ú <strong>${safe}</strong>Í∞ú`
            }
        };

        // Allergen labels by language
        const allergenLabels = {
            en: {
                'eggs': 'Eggs',
                'milk': 'Milk',
                'buckwheat': 'Buckwheat',
                'peanuts': 'Peanuts',
                'soybeans': 'Soybeans',
                'wheat': 'Wheat',
                'mackerel': 'Mackerel',
                'crab': 'Crab',
                'shrimp': 'Shrimp',
                'pork': 'Pork',
                'peach': 'Peach',
                'tomato': 'Tomato',
                'sulfites': 'Sulfites',
                'walnuts': 'Walnuts',
                'chicken': 'Chicken',
                'beef': 'Beef',
                'squid': 'Squid',
                'shellfish': 'Shellfish',
                'pine_nuts': 'Pine Nuts',
                'mussels': 'Mussels',
                'abalone': 'Abalone',
                'oysters': 'Oysters'
            },
            ko: {
                'eggs': 'ÎÇúÎ•ò',
                'milk': 'Ïö∞Ïú†',
                'buckwheat': 'Î©îÎ∞Ä',
                'peanuts': 'ÎïÖÏΩ©',
                'soybeans': 'ÎåÄÎëê',
                'wheat': 'Î∞Ä',
                'mackerel': 'Í≥†Îì±Ïñ¥',
                'crab': 'Í≤å',
                'shrimp': 'ÏÉàÏö∞',
                'pork': 'ÎèºÏßÄÍ≥†Í∏∞',
                'peach': 'Î≥µÏà≠ÏïÑ',
                'tomato': 'ÌÜ†ÎßàÌÜ†',
                'sulfites': 'ÏïÑÌô©ÏÇ∞Î•ò',
                'walnuts': 'Ìò∏Îëê',
                'chicken': 'Îã≠Í≥†Í∏∞',
                'beef': 'Ïá†Í≥†Í∏∞',
                'squid': 'Ïò§ÏßïÏñ¥',
                'shellfish': 'Ï°∞Í∞úÎ•ò',
                'pine_nuts': 'Ïû£',
                'mussels': 'ÌôçÌï©',
                'abalone': 'Ï†ÑÎ≥µ',
                'oysters': 'Íµ¥'
            }
        };

        // Store the current form data for re-fetching
        let currentFormData = null;
        let currentUser = null;
        let bodyCondition = ''; // Store body condition input
        let conversationHistory = []; // Store chat history for context
        let userPreferences = {}; // Store ChatGPT-extracted food preferences
        let currentFilterInfo = null; // Store filter info for language switching

        // Check authentication and load user profile
        async function checkAuth() {
            const token = localStorage.getItem('fitmealor_token');

            if (token) {
                try {
                    const response = await fetch('http://localhost:8000/api/v1/auth/profile', {
                        headers: {
                            'Authorization': 'Bearer ' + token
                        }
                    });

                    if (response.ok) {
                        currentUser = await response.json();
                        displayUserInfo();
                        loadUserProfile();
                    } else {
                        // Token invalid, clear storage
                        localStorage.removeItem('fitmealor_token');
                        localStorage.removeItem('fitmealor_user');
                        showGuestMode();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    showGuestMode();
                }
            } else {
                showGuestMode();
            }
        }

        function displayUserInfo() {
            const navBar = document.getElementById('navBar');
            const navUserName = document.getElementById('navUserName');

            if (currentUser) {
                navBar.style.display = 'flex';
                navUserName.textContent = currentUser.name + ' Îãò';
            }
        }

        function showGuestMode() {
            // Show link to login/register
            const header = document.querySelector('.header');
            const loginLink = document.createElement('p');
            loginLink.innerHTML = '<a href="login.html" style="color: white; text-decoration: underline;">Î°úÍ∑∏Ïù∏ / Login</a> ÎòêÎäî <a href="register.html" style="color: white; text-decoration: underline;">ÌöåÏõêÍ∞ÄÏûÖ / Sign Up</a>';
            loginLink.style.marginTop = '15px';
            header.appendChild(loginLink);

            // Show health form for guest users
            document.getElementById('healthFormCard').style.display = 'block';
        }

        function loadUserProfile() {
            if (!currentUser) return;

            // Hide health form for logged-in users
            document.getElementById('healthFormCard').style.display = 'none';

            // Show welcome card, chat card, and allergen filter card
            document.getElementById('welcomeCard').style.display = 'block';
            document.getElementById('chatCard').style.display = 'block';
            document.getElementById('allergenFilterCard').style.display = 'block';

            // Display user info in welcome card
            const goalLabels = {
                'lose_weight': 'Lose Weight / Ï≤¥Ï§ë Í∞êÎüâ',
                'maintain': 'Maintain / Ïú†ÏßÄ',
                'gain_muscle': 'Gain Muscle / Í∑ºÏú° Ï¶ùÍ∞Ä',
                'bulk_up': 'Bulk Up / Î≤åÌÅ¨ÏóÖ'
            };

            document.getElementById('welcomeUserName').textContent = currentUser.name;
            document.getElementById('welcomeGoal').textContent = goalLabels[currentUser.health_goal] || currentUser.health_goal;
            document.getElementById('welcomeWeight').textContent = currentUser.weight_kg + ' kg';
            document.getElementById('welcomeTargetWeight').textContent = currentUser.target_weight_kg + ' kg';

            // Calculate TDEE
            let bmr;
            if (currentUser.gender === 'male') {
                bmr = 10 * currentUser.weight_kg + 6.25 * currentUser.height_cm - 5 * currentUser.age + 5;
            } else if (currentUser.gender === 'female') {
                bmr = 10 * currentUser.weight_kg + 6.25 * currentUser.height_cm - 5 * currentUser.age - 161;
            } else {
                bmr = 10 * currentUser.weight_kg + 6.25 * currentUser.height_cm - 5 * currentUser.age - 78;
            }
            const tdee = Math.round(bmr * 1.55);
            document.getElementById('welcomeTDEE').textContent = tdee + ' kcal/day';

            // Set allergen filters based on user profile
            document.querySelectorAll('.allergen-filter-checkbox').forEach(cb => {
                cb.checked = currentUser.allergies.includes(cb.value);
            });

            // Add event listeners to allergen filter checkboxes
            document.querySelectorAll('.allergen-filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    if (currentFormData) {
                        fetchRecommendations();
                    }
                });
            });

            // Auto-fill form data for recommendation
            currentFormData = {
                user_id: currentUser.email,
                age: currentUser.age,
                gender: currentUser.gender,
                height_cm: currentUser.height_cm,
                weight_kg: currentUser.weight_kg,
                target_weight_kg: currentUser.target_weight_kg,
                activity_level: currentUser.activity_level,
                health_goal: currentUser.health_goal
            };

            // Auto-load recommendations for logged-in users
            fetchRecommendations();
        }

        // Logout
        document.getElementById('navLogoutBtn')?.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm('Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå? / Do you want to logout?')) {
                localStorage.removeItem('fitmealor_token');
                localStorage.removeItem('fitmealor_user');
                // Keep auto-login credentials for next login
                window.location.href = 'login.html';
            }
        });

        // Function to get selected allergies from checkboxes
        function getSelectedAllergies() {
            // For logged-in users, use filter checkboxes
            if (currentUser) {
                const checkboxes = document.querySelectorAll('.allergen-filter-checkbox:checked');
                return Array.from(checkboxes).map(cb => cb.value);
            }
            // For guest users, use form checkboxes
            const checkboxes = document.querySelectorAll('.allergen-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', checkAuth);

        // Function to fetch recommendations
        async function fetchRecommendations() {
            if (!currentFormData) return;

            const allergies = getSelectedAllergies();
            const data = {
                ...currentFormData,
                allergies,
                body_condition: bodyCondition,  // Add body condition to request
                preferences: userPreferences  // Add ChatGPT-extracted food preferences
            };

            // Show loading
            document.getElementById('results').style.display = 'block';
            document.getElementById('mealsContainer').innerHTML = `<div class="loading">${messages.loading[currentLanguage]}</div>`;

            try {
                const response = await fetch('http://localhost:8000/api/v1/recommendations/recommend', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                // Display recommendation reason if available
                if (result.recommendation_reason) {
                    document.getElementById('recommendationReason').style.display = 'block';
                    document.getElementById('reasonText').textContent = result.recommendation_reason;
                } else {
                    document.getElementById('recommendationReason').style.display = 'none';
                }

                // Display TDEE
                document.getElementById('tdeeValue').textContent = `${result.tdee} kcal/day`;

                // Update filter info
                const filterInfoDiv = document.getElementById('filterInfo');
                const filterListP = document.getElementById('filterList');
                const filterStatsP = document.getElementById('filterStats');

                if (allergies.length > 0) {
                    filterInfoDiv.style.display = 'block';
                    const selectedLabels = allergies.map(a => allergenLabels[currentLanguage][a] || a);
                    filterListP.textContent = selectedLabels.join(', ');
                    filterStatsP.innerHTML = messages.filterStats[currentLanguage](result.total_available, result.filtered_out, result.total_recommendations);

                    // Store filter info for language switching
                    currentFilterInfo = {
                        allergies: allergies,
                        total_available: result.total_available,
                        filtered_out: result.filtered_out,
                        total_recommendations: result.total_recommendations
                    };
                } else {
                    filterInfoDiv.style.display = 'none';
                    currentFilterInfo = null;
                }

                // Store recommendations for language switching
                currentRecommendations = result.recommendations;

                // Display meals
                const mealsHTML = result.recommendations.map(meal => `
                    <div class="meal-card">
                        <h3>${currentLanguage === 'en' ? (meal.name_en || meal.name) : meal.name}</h3>
                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                            ${meal.brand ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">üè¢ ${meal.brand}</span>` : ''}
                            ${meal.category ? `<span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">üì¶ ${meal.category}</span>` : ''}
                        </div>
                        <span class="safe-badge safe">
                            ${currentLanguage === 'en' ? '‚úÖ Safe for your allergies' : '‚úÖ ÏïåÎ†àÎ•¥Í∏∞ ÏïàÏ†Ñ'}
                        </span>
                        ${meal.serving_size ? `<p style="color: #555; font-size: 14px; margin-top: 8px; margin-bottom: 15px;"><strong>${currentLanguage === 'en' ? 'Serving Size:' : '1Ìöå Ï†úÍ≥µÎüâ:'}</strong> ${meal.serving_size}</p>` : ''}
                        ${meal.origin ? `<p style="color: #555; font-size: 14px; margin-bottom: 15px;"><strong>${currentLanguage === 'en' ? 'Origin:' : 'ÏõêÏÇ∞ÏßÄ:'}</strong> ${meal.origin}</p>` : ''}
                        <div class="meal-stats">
                            <div class="stat">
                                <div class="stat-value">${meal.calories}</div>
                                <div class="stat-label">${currentLanguage === 'en' ? 'Calories' : 'ÏπºÎ°úÎ¶¨'}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${meal.protein_g}g</div>
                                <div class="stat-label">${currentLanguage === 'en' ? 'Protein' : 'Îã®Î∞±Ïßà'}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${meal.carbs_g}g</div>
                                <div class="stat-label">${currentLanguage === 'en' ? 'Carbs' : 'ÌÉÑÏàòÌôîÎ¨º'}</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${meal.fat_g}g</div>
                                <div class="stat-label">${currentLanguage === 'en' ? 'Fat' : 'ÏßÄÎ∞©'}</div>
                            </div>
                            ${meal.sodium_mg ? `<div class="stat">
                                <div class="stat-value">${meal.sodium_mg}mg</div>
                                <div class="stat-label">${currentLanguage === 'en' ? 'Sodium' : 'ÎÇòÌä∏Î•®'}</div>
                            </div>` : ''}
                        </div>
                        <p style="color: #666; line-height: 1.6;">
                            ${currentLanguage === 'en' ? meal.explanation_en : meal.explanation_ko}
                        </p>
                        <p style="margin-top: 10px; color: #667eea; font-weight: 600;">
                            ${currentLanguage === 'en' ? 'AI Score:' : 'AI Ï†êÏàò:'} ${meal.score}/100
                        </p>
                    </div>
                `).join('');

                document.getElementById('mealsContainer').innerHTML = mealsHTML ||
                    `<div style="text-align: center; padding: 40px; color: #666;">${messages.noMeals[currentLanguage]}</div>`;

            } catch (error) {
                document.getElementById('mealsContainer').innerHTML = `
                    <div style="color: #d32f2f; padding: 20px; text-align: center;">
                        ${messages.error[currentLanguage]}${error.message}<br>
                        ${messages.serverError[currentLanguage]}
                    </div>
                `;
            }
        }

        // Form submit handler
        document.getElementById('healthForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Store form data
            currentFormData = {
                user_id: 'demo-user',
                age: parseInt(document.getElementById('age').value),
                gender: document.getElementById('gender').value,
                height_cm: parseFloat(document.getElementById('height').value),
                weight_kg: parseFloat(document.getElementById('weight').value),
                target_weight_kg: parseFloat(document.getElementById('targetWeight').value),
                activity_level: document.getElementById('activity').value,
                health_goal: document.getElementById('goal').value
            };

            await fetchRecommendations();
        });

        // Add event listeners to all allergen checkboxes
        document.querySelectorAll('.allergen-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                if (currentFormData) {
                    fetchRecommendations();
                }
            });
        });

        // Chat functionality
        function addChatMessage(message, isUser = false) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            messageDiv.textContent = message;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle chat send
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const chatSendBtn = document.getElementById('chatSendBtn');
            const message = chatInput.value.trim();

            if (!message) return;

            // Add user message to chat
            addChatMessage(message, true);

            // Add typing indicator
            const chatMessages = document.getElementById('chatMessages');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'chat-message assistant';
            typingIndicator.id = 'typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Disable input
            chatInput.disabled = true;
            chatSendBtn.disabled = true;
            chatSendBtn.textContent = 'üí¨ Thinking...';
            chatInput.value = '';

            try {
                // Call ChatGPT API
                const response = await fetch('http://localhost:8000/api/v1/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        conversation_history: conversationHistory
                    })
                });

                const result = await response.json();

                // Remove typing indicator
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }

                // Add assistant response to chat
                addChatMessage(result.response, false);

                // Update conversation history
                conversationHistory.push({
                    role: 'user',
                    content: message
                });
                conversationHistory.push({
                    role: 'assistant',
                    content: result.response
                });

                // Keep only last 10 messages (5 exchanges) for context
                if (conversationHistory.length > 10) {
                    conversationHistory = conversationHistory.slice(-10);
                }

                // Update body condition for meal recommendations
                bodyCondition = result.dietary_summary || message;

                // Store preferences from ChatGPT
                if (result.preferences) {
                    userPreferences = result.preferences;
                    console.log('Updated preferences:', userPreferences);
                }

                // Refresh recommendations if available
                if (currentFormData) {
                    await fetchRecommendations();
                }

            } catch (error) {
                console.error('Chat error:', error);

                // Remove typing indicator on error
                const indicator = document.getElementById('typing-indicator');
                if (indicator) {
                    indicator.remove();
                }

                addChatMessage('Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÏùºÏãúÏ†ÅÏù∏ Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\nSorry, there was a temporary error.', false);
            }

            // Re-enable input
            chatInput.disabled = false;
            chatSendBtn.disabled = false;
            chatSendBtn.textContent = 'üí¨ Send / Ï†ÑÏÜ°';
        }

        document.getElementById('chatSendBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Function to re-render meals with current language
        function renderMeals() {
            if (!currentRecommendations) return;

            const mealsHTML = currentRecommendations.map(meal => `
                <div class="meal-card">
                    <h3>${currentLanguage === 'en' ? (meal.name_en || meal.name) : meal.name}</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        ${meal.brand ? `<span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">üè¢ ${meal.brand}</span>` : ''}
                        ${meal.category ? `<span style="background: #e3f2fd; color: #1976d2; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 600;">üì¶ ${meal.category}</span>` : ''}
                    </div>
                    <span class="safe-badge safe">
                        ${currentLanguage === 'en' ? '‚úÖ Safe for your allergies' : '‚úÖ ÏïåÎ†àÎ•¥Í∏∞ ÏïàÏ†Ñ'}
                    </span>
                    ${meal.serving_size ? `<p style="color: #555; font-size: 14px; margin-top: 8px; margin-bottom: 15px;"><strong>${currentLanguage === 'en' ? 'Serving Size:' : '1Ìöå Ï†úÍ≥µÎüâ:'}</strong> ${meal.serving_size}</p>` : ''}
                    ${meal.origin ? `<p style="color: #555; font-size: 14px; margin-bottom: 15px;"><strong>${currentLanguage === 'en' ? 'Origin:' : 'ÏõêÏÇ∞ÏßÄ:'}</strong> ${meal.origin}</p>` : ''}
                    <div class="meal-stats">
                        <div class="stat">
                            <div class="stat-value">${meal.calories}</div>
                            <div class="stat-label">${currentLanguage === 'en' ? 'Calories' : 'ÏπºÎ°úÎ¶¨'}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${meal.protein_g}g</div>
                            <div class="stat-label">${currentLanguage === 'en' ? 'Protein' : 'Îã®Î∞±Ïßà'}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${meal.carbs_g}g</div>
                            <div class="stat-label">${currentLanguage === 'en' ? 'Carbs' : 'ÌÉÑÏàòÌôîÎ¨º'}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${meal.fat_g}g</div>
                            <div class="stat-label">${currentLanguage === 'en' ? 'Fat' : 'ÏßÄÎ∞©'}</div>
                        </div>
                        ${meal.sodium_mg ? `<div class="stat">
                            <div class="stat-value">${meal.sodium_mg}mg</div>
                            <div class="stat-label">${currentLanguage === 'en' ? 'Sodium' : 'ÎÇòÌä∏Î•®'}</div>
                        </div>` : ''}
                    </div>
                    <p style="color: #666; line-height: 1.6;">
                        ${currentLanguage === 'en' ? meal.explanation_en : meal.explanation_ko}
                    </p>
                    <p style="margin-top: 10px; color: #667eea; font-weight: 600;">
                        ${currentLanguage === 'en' ? 'AI Score:' : 'AI Ï†êÏàò:'} ${meal.score}/100
                    </p>
                </div>
            `).join('');

            document.getElementById('mealsContainer').innerHTML = mealsHTML;
        }

        // Function to update all UI text based on language
        function updateLanguage() {
            const lang = currentLanguage;

            // Update all elements with data-lang attributes
            document.querySelectorAll('[data-lang-en][data-lang-ko]').forEach(el => {
                if (lang === 'en') {
                    el.textContent = el.getAttribute('data-lang-en');
                } else {
                    el.textContent = el.getAttribute('data-lang-ko');
                }
            });

            // Update all input placeholders with data-placeholder attributes
            document.querySelectorAll('[data-placeholder-en][data-placeholder-ko]').forEach(el => {
                if (lang === 'en') {
                    el.placeholder = el.getAttribute('data-placeholder-en');
                } else {
                    el.placeholder = el.getAttribute('data-placeholder-ko');
                }
            });

            // Update filter info if it exists
            if (currentFilterInfo) {
                const filterListP = document.getElementById('filterList');
                const filterStatsP = document.getElementById('filterStats');

                const selectedLabels = currentFilterInfo.allergies.map(a => allergenLabels[lang][a] || a);
                filterListP.textContent = selectedLabels.join(', ');
                filterStatsP.innerHTML = messages.filterStats[lang](
                    currentFilterInfo.total_available,
                    currentFilterInfo.filtered_out,
                    currentFilterInfo.total_recommendations
                );
            }

            // Re-render meals if they exist
            renderMeals();
        }

        // Language toggle event listener
        const languageToggle = document.getElementById('languageToggle');
        if (languageToggle) {
            // Set initial state
            if (currentLanguage === 'en') {
                languageToggle.checked = true;
            }

            // Apply initial language
            updateLanguage();

            // Listen for toggle changes
            languageToggle.addEventListener('change', (e) => {
                currentLanguage = e.target.checked ? 'en' : 'ko';
                localStorage.setItem('fitmealor_language', currentLanguage);

                // Update all UI text
                updateLanguage();
            });
        }
    </script>
</body>
</html>
